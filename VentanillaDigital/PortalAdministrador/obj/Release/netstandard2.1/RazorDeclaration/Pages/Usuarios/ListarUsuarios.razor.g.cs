// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace PortalAdministrador.Pages.Usuarios
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
#nullable restore
#line 1 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.Extensions.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador.Components.Transversales;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador.Services.Parametrizacion;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using BlazorStrap;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Radzen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using Radzen.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador.Components.Tramites;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministrador.Components.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\_Imports.razor"
using PortalAdministracion.Services.UsuarioAdministracion;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using Infraestructura.Transversal.Log.Modelo;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using Infraestructura.Transversal.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using ApiGateway.Contratos.Models.Account;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using ApiGateway.Contratos.Models.LogTrazabilidad;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using System.Text;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using ApiGateway.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using PortalAdministrador.Data.Account;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using Microsoft.AspNetCore.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using PortalAdministrador.Validators;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using System.Diagnostics;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/usuarios")]
    public partial class ListarUsuarios : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 235 "D:\VentanillaDigitalGit\Web.Application.NotariaFijaYMovil\VentanillaDigital\PortalAdministrador\Pages\Usuarios\ListarUsuarios.razor"
       

    [Inject]
    IJSRuntime Js { get; set; }
    #region Propiedades
    public List<(string, string)> Columns { get; set; } = new List<(string, string)>
{
        ("Correo", "Email"),
        ("Rol", "RolName"),
        ("Documento", "Documento"),
        ("Persona", "PersonaName"),
        ("Notaría", "NotariaName"),
    };
    string TituloModal;
    string Estado = string.Empty;
    string Mensaje = string.Empty;
    string EstadoEliminacion = string.Empty;
    string MensajeEliminacion = string.Empty;
    public bool usuariosEliminados = false;
    List<AspNetUsersResponseDTO> usuarios;
    AspNetUsersResponseDTO selectedUser;

    public string mensajeErrorClase = "";
    public string errorInputClase = "";
    public string modalCrearUsuarioId = "createUserModalCenter";
    public string deleteUserModalCenter = "deleteUserModalCenter";
    bool showSpinner;
    bool esUsuarioCreado;
    UserAccount userAccount = ResetUser();
    private CustomValidator customValidator;

    public List<UsuarioModel> Usuarios { get; set; }
    public int TotalPages { get; set; }
    public long TotalRows { get; set; }
    public GridControl<UsuarioModel> Grid { get; set; }
    public long NotariaSeleccionada { get; set; }
    public string NumeroIdentificacionFilter { get; set; }
    public string CorreoFilter { get; set; }
    public bool FiltrosVisibles { get; set; } = true;
    public bool consultando { get; set; }
    bool preventDefault = false;
    public IEnumerable<ApiGateway.Contratos.Models.NotariaBasicModel> Notarias { get; set; }
    bool esUsuarioAdmin = false;
    #endregion

    #region Overrides
    protected override async Task OnInitializedAsync()
    {
        var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
        esUsuarioAdmin = state.User.IsInRole("ADMIN");
        await ConsultarUsuarios(1);
        await ConsultarNotarias();
    }
    #endregion

    #region Privates
    static UserAccount ResetUser()
    {
        return new UserAccount()
        {
            RolId = 1,
            EsUsuarioNotaria = true,
            personaDatos = null,
            Genero = 0
        };
    }

    private async Task HandleValidSubmit()
    {
        customValidator.ClearErrors();

        var errors = new Dictionary<string, List<string>>();

        if (errors.Count() > 0)
        {
            customValidator.DisplayErrors(errors);
        }
        else
        {
            await SaveUserAlt();
        }
    }

    void ConfigurarModal()
    {
        esUsuarioCreado = false;
        userAccount = ResetUser();
        TituloModal = "Nuevo notario principal";
    }

    private async Task OnDeleteItem(UsuarioModel usuarioModel)
    {
        selectedUser = await _accountService.ObtenerUsuarioNotariaPorId(new Guid(usuarioModel.Id));
        await Js.InvokeVoidAsync("cerrarModal", deleteUserModalCenter);
    }

    private async Task RemoveUsersSelected()
    {
        if (selectedUser != null)
        {
            UserDelete ud = new UserDelete()
            {
                Id = selectedUser.Id,
                Email = selectedUser.Email,
                NotariaId = selectedUser.NotariaId
            };

            var stopwatch = new Stopwatch();
            try
            {
                showSpinner = true;
                Estado = "Eliminar usuario";
                stopwatch.Start();
                var resultado = await _accountService.UserDelete(ud);
                stopwatch.Stop();
                TimeSpan timeTaken = stopwatch.Elapsed;
                if (resultado)
                {
                    Mensaje = $"Se ha eliminado correctamente al usuario {selectedUser.Email}";
                    ShowMessage(NotificationSeverity.Info, string.Empty, Mensaje);
                    await ConsultarUsuarios(1);
                }
                else
                {
                    Mensaje = $"Error al eliminar al usuario {selectedUser.Email}, si el error persiste por favor comunicarse con el administrador";
                    ShowMessage(NotificationSeverity.Error, string.Empty, Mensaje);
                }
                var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
                LogTrazabilidadModel log = new LogTrazabilidadModel
                {
                    Usuario = state.User.Claims
                    .Where(x => x.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name")
                    .Select(x => x.Value).FirstOrDefault(),
                    NotariaId = selectedUser.NotariaId,
                    Peticion = JsonConvert.SerializeObject(ud),
                    FechaRegistro = DateTime.Now.ToLongDateString(),
                    Tiempo = $"{timeTaken.ToString(@"m\:ss\.fff")}",
                    Mensaje = Mensaje
                };

                await AgregarLog($"{JsonConvert.SerializeObject(log)}", "RemoveUsersSelected", "UserDelete");
            }
            catch (Exception ex)
            {
                Estado = "Error";
                Mensaje = ex.Message;
                ShowMessage(NotificationSeverity.Error, string.Empty, Mensaje);
                showSpinner = false;
                TimeSpan timeTaken = stopwatch.Elapsed;
                var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
                LogTrazabilidadModel log = new LogTrazabilidadModel
                {
                    Usuario = state.User.Claims
                    .Where(x => x.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name")
                    .Select(x => x.Value).FirstOrDefault(),
                    NotariaId = selectedUser.NotariaId,
                    Peticion = JsonConvert.SerializeObject(ud),
                    FechaRegistro = DateTime.Now.ToLongDateString(),
                    Tiempo = $"{timeTaken.ToString(@"m\:ss\.fff")}",
                    Mensaje = Mensaje
                };

                await AgregarLog($"{JsonConvert.SerializeObject(log)}", "RemoveUsersSelected", "Exception");
            }
            finally
            {
                showSpinner = false;
                await Js.InvokeVoidAsync("cerrarModal", deleteUserModalCenter);
                StateHasChanged();
            }
        }
    }

    private async Task OnEditClick(UsuarioModel userAccount2)
    {
        TituloModal = "Actualizar información de usuario notarial";
        userAccount = ResetUser();
        esUsuarioCreado = true;
        var stopwatch = new Stopwatch();
        stopwatch.Start();
        var usuarioSeleccionado = await _accountService.ObtenerUsuarioNotariaPorId(new Guid(userAccount2.Id));
        stopwatch.Stop();
        TimeSpan timeSpan = stopwatch.Elapsed;
        if (usuarioSeleccionado != null)
        {
            userAccount.Nombres = usuarioSeleccionado.Nombres;
            userAccount.Apellidos = usuarioSeleccionado.Apellidos;
            userAccount.Cargo = usuarioSeleccionado.Cargo;
            userAccount.Area = usuarioSeleccionado.Area;
            userAccount.Genero = usuarioSeleccionado.Genero ?? 0;
            userAccount.NumeroDocumento = usuarioSeleccionado.NumeroIdentificacion;
            userAccount.TipoIdentificacionId = 1;
            userAccount.NumeroCelular = usuarioSeleccionado.NumeroCelular;
            userAccount.EmailNotaria = usuarioSeleccionado.Email;
            userAccount.NotariaId = usuarioSeleccionado.NotariaId;
            userAccount.Id = usuarioSeleccionado.Id;
            userAccount.UserId = usuarioSeleccionado.Id;
            await Js.InvokeVoidAsync("cerrarModal", "createUserModalCenter");
            await AgregarLog($"[{timeSpan.ToString(@"m\:ss\.fff")}] {Mensaje}", "OnEditClick", "UserAccount");
            StateHasChanged();
        }
        else
        {
            Estado = "No se ha encontrado el usuario.";
            Mensaje = "No se ha encontrado el usuario solicitado. Probablemente haya sido eliminado.";
            await AgregarLog($"[{timeSpan.ToString(@"m\:ss\.fff")}] {Mensaje}", "OnEditClick", "Exception");
            ShowMessage(NotificationSeverity.Warning, Estado, Mensaje);
        }
    }

    private async Task InputNumberKeyboardEventHandler(KeyboardEventArgs args)
    {
        byte codAscii = Encoding.ASCII.GetBytes(args.Key.ToString())[0];

        if ((codAscii >= 48 && codAscii <= 57) ||
             (args.Code == "Enter" || args.Code == "NumpadEnter") ||
             codAscii == 66 || codAscii == 68 ||
             codAscii == 65 || codAscii == 84)
        {

            this.preventDefault = false;
        }
        else
        {
            this.preventDefault = true;
        }
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Filtrar();
        }
    }

    private async Task SaveUserAlt()
    {
        showSpinner = true;
        var stopwatch = new Stopwatch();
        try
        {
            userAccount.EmailPersonal = userAccount.EmailNotaria;
            stopwatch.Start();
            if (esUsuarioCreado)
            {
                await _accountService.UserUpdate(userAccount);
                Estado = "Usuario actualizado";
                Mensaje = "Se ha actualizado correctamente los datos del usuario " + userAccount.EmailNotaria;
            }
            else
            {
                await _accountService.UserRegister(userAccount);
                Estado = "Usuario creado";
                Mensaje = "Se ha creado el usuario " + userAccount.EmailNotaria + " en su Notaria. Se enviará un correo electrónico al funcionario para ingresar al sistema.";
            }
            stopwatch.Stop();
            TimeSpan timeSpan = stopwatch.Elapsed;

            var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
            LogTrazabilidadModel log = new LogTrazabilidadModel
            {
                Usuario = state.User.Claims.Where(x => x.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name")
                .Select(x => x.Value).FirstOrDefault(),
                NotariaId = userAccount.NotariaId,
                Peticion = JsonConvert.SerializeObject(userAccount),
                FechaRegistro = DateTime.Now.ToLongDateString(),
                Tiempo = $"{timeSpan.ToString(@"m\:ss\.fff")}",
                Mensaje = Mensaje
            };

            await AgregarLog($"{JsonConvert.SerializeObject(log)}", esUsuarioCreado ?
                "OnEditClick" : "SaveUserAlt", "UserAccount");

            await ConsultarUsuarios(1);
            await ClosedModalWindow(modalCrearUsuarioId);
            ShowMessage(NotificationSeverity.Success, Estado, Mensaje);
            showSpinner = false;
            esUsuarioCreado = false;
            userAccount = ResetUser();
            StateHasChanged();
        }
        catch (Exception e)
        {
            Estado = "Error al crear el usuario";
            showSpinner = false;
            Mensaje = $"Error al crear el usuario {userAccount.EmailNotaria}. {e.Message}";
            TimeSpan timeSpan = stopwatch.Elapsed;
            var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
            LogTrazabilidadModel log = new LogTrazabilidadModel
            {
                Usuario = state.User.Claims.Where(x => x.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name")
                .Select(x => x.Value).FirstOrDefault(),
                NotariaId = userAccount.NotariaId,
                Peticion = JsonConvert.SerializeObject(userAccount),
                FechaRegistro = DateTime.Now.ToLongDateString(),
                Tiempo = $"{timeSpan.ToString(@"m\:ss\.fff")}",
                Mensaje = Mensaje
            };

            await AgregarLog($"{JsonConvert.SerializeObject(log)}", esUsuarioCreado ?
                "OnEditClick" : "SaveUserAlt", "Exception");
            await ClosedModalWindow(modalCrearUsuarioId);
            ShowMessage(NotificationSeverity.Error, Estado, Mensaje);
            await ConsultarUsuarios(1);
            userAccount = ResetUser();
            esUsuarioCreado = false;
            StateHasChanged();
        }
    }

    public async Task ClosedModalWindow(string Id)
    {
        await Js.InvokeVoidAsync("cerrarModal", Id);
    }

    protected void ShowMessage(NotificationSeverity notificationSeverity, string Summary, string Message)
    {
        var message = new NotificationMessage()
        {
            Severity = notificationSeverity,
            Summary = $"{Summary}",
            Detail = $"{Message}",
            Duration = 4000
        };
        notificationService.Notify(message);
    }

    public async void OnChangePage(int indice)
    {
        await ConsultarUsuarios(indice);
    }

    public async Task Refrescar()
    {
        Grid.ResetIndex();
        await ConsultarUsuarios(1);
    }

    public async Task MostrarFiltros(bool mostrarOverlay = true)
    {
        //FiltrosVisibles = !FiltrosVisibles;
        await Js.InvokeVoidAsync("mostrarFiltros", mostrarOverlay);
    }

    public async Task LimpiarCampos()
    {
        NotariaSeleccionada = 0;
        NumeroIdentificacionFilter = string.Empty;
        CorreoFilter = string.Empty;
        await ConsultarUsuarios(1);
    }

    public async Task Filtrar()
    {
        await ConsultarUsuarios(indice: 1);
        Grid.ResetIndex();
        await MostrarFiltros(false);
    }

    public async Task ConsultarNotarias()
    {
        Notarias = await _notariaService.ObtenerNotariasAsync();
    }

    private async Task AgregarLog(string exception, string metodo, string entidad)
    {
        var state = await _authenticationStateProvider.GetAuthenticationStateAsync();
        InformationModel objTraza = new InformationModel("1",
           "PortalAdministrador",
           "ListarUsuarios",
           metodo,
           entidad,
           null,
           exception, state.User.Identity.Name);
        await _trazabilidadService.CrearTraza(objTraza);
    }

    public async Task ConsultarUsuarios(int indice)
    {
        consultando = true;
        var model = new DefinicionFiltro();
        model.IndicePagina = indice;
        model.TotalRegistros = 0;
        model.RegistrosPagina = 10;
        model.Filtros = new List<Filtro>();

        if (NotariaSeleccionada > 0) model.Filtros.Add(new Filtro("NotariaId", NotariaSeleccionada.ToString()));
        if (!string.IsNullOrEmpty(NumeroIdentificacionFilter)) model.Filtros.Add(new Filtro("Documento", NumeroIdentificacionFilter));
        if (!string.IsNullOrEmpty(CorreoFilter)) model.Filtros.Add(new Filtro("Correo", CorreoFilter));

        var stopwatch = new Stopwatch();
        stopwatch.Start();
        var res = await _accountService.ObtenerUsuariosPaginado(model);
        stopwatch.Stop();
        var timeSpan = stopwatch.Elapsed;
        await AgregarLog($"[{timeSpan.ToString(@"m\:ss\.fff")}] {Mensaje}", "ConsultarUsuarios", "DefinicionFiltro");

        if (res != null)
        {
            Usuarios = res.Data?.ToList();
            TotalRows = res.TotalRows;
            TotalPages = res.Pages;
        }

        consultando = false;

        StateHasChanged();
    }
    #endregion

    public enum Genero
    {
        Masculino = 1,
        Femenino = 2
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider _authenticationStateProvider { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Radzen.NotificationService notificationService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private PortalAdministrador.Services.ITrazabilidadService _trazabilidadService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private PortalAdministrador.Services.Notaria.INotariaService _notariaService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private PortalAdministrador.Services.IAccountService _accountService { get; set; }
    }
}
#pragma warning restore 1591
